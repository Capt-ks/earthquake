name: Update Earthquake Card Image

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  generate-and-commit-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          pip install pillow requests

      - name: Generate Earthquake Card
        run: |
          python3 << 'EOF'
          import requests
          from PIL import Image, ImageDraw, ImageFont, UnidentifiedImageError
          from datetime import datetime, timezone
          import io, textwrap
          import traceback
          import os

          def generate_card():
              print("Starting earthquake card generation...")

              FEED = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_week.geojson"

              try:
                  resp = requests.get(FEED, timeout=20)
                  resp.raise_for_status()
                  data = resp.json()
                  print("USGS feed fetched OK")
              except Exception as e:
                  print("Error fetching USGS feed:", e)
                  data = None

              quakes = []

              if data and "features" in data:
                  for f in data["features"]:
                      try:
                          mag = f["properties"]["mag"]
                          place = f["properties"]["place"]
                          time_ms = f["properties"]["time"]
                          lon, lat, depth = f["geometry"]["coordinates"]
                      except Exception as e:
                          print("Error parsing feature:", e)
                          continue

                      if mag and mag >= 3.5:
                          if 17.6 <= lat <= 19.0 and -67.0 <= lon <= -63.8:
                              quakes.append({
                                  "mag": mag,
                                  "place": place,
                                  "lat": lat,
                                  "lon": lon,
                                  "depth": depth,
                                  "time": time_ms
                              })

                  quakes.sort(key=lambda x: x["time"], reverse=True)
                  quakes = quakes[:3]

              # Text formatting
              quake_lines_raw = []

              if not quakes:
                  print("No quakes found in region, using fallback text")
                  quake_lines_raw = ["No recent earthquakes ≥ 3.5 detected."]
              else:
                  first = True
                  for q in quakes:
                      label = "Currently" if first else "Recent"
                      first = False
                      t = datetime.fromtimestamp(q["time"] / 1000, tz=timezone.utc)
                      time_str = t.strftime("%b %d, %Y %H:%M UTC")
                      line = (
                          f"{label}: M{q['mag']:.1f} – {q['place']} – "
                          f"Depth {int(q['depth'])} km – {time_str}"
                      )
                      quake_lines_raw.extend(textwrap.wrap(line, width=52))
                      quake_lines_raw.append("")

              quake_text = "\n".join(quake_lines_raw)

              # Card background
              card = Image.new("RGB", (800, 900), "#f2f6fa")
              draw = ImageDraw.Draw(card)

              # Logo
              try:
                  logo_resp = requests.get(
                      "https://static.wixstatic.com/media/80c250_b1146919dfe046429a96648c59e2c413~mv2.png",
                      timeout=20
                  )
                  logo_resp.raise_for_status()
                  logo = Image.open(io.BytesIO(logo_resp.content)).convert("RGBA")
                  print("Logo loaded OK")
              except Exception as e:
                  print("Error loading logo, using fallback:", e)
                  logo = Image.new("RGBA", (120, 120), "white")

              logo = logo.resize((120, 120))
              card.paste(logo, (40, 40), logo)

              # Fonts
              try:
                  font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 36)
                  font_sub = ImageFont.truetype("DejaVuSans.ttf", 32)
                  font_body = ImageFont.truetype("DejaVuSans.ttf", 21)
                  font_footer = ImageFont.truetype("DejaVuSans.ttf", 18)
                  print("Fonts loaded OK")
              except Exception as e:
                  print("Error loading fonts, using default:", e)
                  font_title = font_sub = font_body = font_footer = ImageFont.load_default()

              TEXT = "#0a1a2f"

              # Header
              today_str = datetime.now().strftime("%b %d, %Y")
              draw.text((200, 80), today_str, fill=TEXT, font=font_title)

              draw.text((400, 180), "Earthquake Activity", fill=TEXT, font=font_sub, anchor="mm")
              draw.text((400, 230), "Near Puerto Rico (M3.5+)", fill=TEXT, font=font_sub, anchor="mm")

              draw.multiline_text(
                  (80, 300),
                  quake_text,
                  fill=TEXT,
                  font=font_body,
                  spacing=6
              )

              # Mini map using satellite image
              LAT_MIN, LAT_MAX = 17.6, 19.0
              LON_MIN, LON_MAX = -67.0, -63.8

              def map_coords(lat, lon, width, height):
                  x = int((lon - LON_MIN) / (LON_MAX - LON_MIN) * width)
                  y = int((LAT_MAX - lat) / (LAT_MAX - LAT_MIN) * height)
                  return x, y

              # Load satellite map
              try:
                  print("Fetching satellite base map...")
                  base_map_resp = requests.get(
                      "https://static.wixstatic.com/media/80c250_c027bc919fc244e19f0bd205e225f5cf~mv2.png/v1/fill/w_1200,h_666,al_c,q_90,usm_0.66_1.00_0.01,enc_avif,quality_auto/Screenshot%202026-01-02%20at%2018_58_02.png",
                      timeout=20
                  )
                  base_map_resp.raise_for_status()
                  try:
                      base_map = Image.open(io.BytesIO(base_map_resp.content)).convert("RGB")
                      print("Satellite base map loaded OK")
                  except UnidentifiedImageError as e:
                      print("Base map format not supported, using fallback:", e)
                      base_map = Image.new("RGB", (1200, 666), "#d9e3ec")
              except Exception as e:
                  print("Error fetching base map, using fallback:", e)
                  base_map = Image.new("RGB", (1200, 666), "#d9e3ec")

              map_img = base_map.resize((300, 300))
              map_draw = ImageDraw.Draw(map_img)

              # Quake dots
              for q in quakes:
                  try:
                      x, y = map_coords(q["lat"], q["lon"], 300, 300)
                      map_draw.ellipse((x-6, y-6, x+6, y+6), fill="red")
                  except Exception as e:
                      print("Error plotting quake on map:", e)

              bordered = Image.new("RGB", (304, 304), "white")
              bordered.paste(map_img, (2, 2))

              card.paste(bordered, (250, 580))

              # Footer
              footer = "USGS Earthquake Data | RabirubiaWeather.com | Updated every 4 hours"
              draw.text((400, 860), footer, fill=TEXT, font=font_footer, anchor="mm")

              card.save("earthquake_card.png", optimize=True)
              print("Card saved as earthquake_card.png")
              print("File exists:", os.path.exists("earthquake_card.png"))

          if __name__ == "__main__":
              try:
                  generate_card()
              except Exception as e:
                  print("FATAL ERROR generating card:")
                  traceback.print_exc()
                  # Fallback: create a simple error card so the file still exists
                  card = Image.new("RGB", (800, 900), "white")
                  draw = ImageDraw.Draw(card)
                  draw.text((50, 400), "Error generating earthquake card", fill="red")
                  card.save("earthquake_card.png")
                  print("Fallback earthquake_card.png saved after error")
          EOF

      - name: Commit and push updated image
        run: |
          if [ ! -f earthquake_card.png ]; then
            echo "ERROR: earthquake_card.png not found — aborting commit"
            ls -la
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add earthquake_card.png
          git commit -m "Auto-update earthquake card image" || echo "No changes to commit"
          git push
